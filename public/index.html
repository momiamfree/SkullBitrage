<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SkullBitrage</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="icon" type="image/png" href="SKULLKID.png" />
  <link rel="stylesheet" type="text/css" href="index.css">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- üîπ Cargar token desde el backend -->
  <script src="/config.js"></script>
</head>
<body class="bg-dark text-light">
  <div id="root"></div>

  <script type="text/babel">
    const BASE_URL = "/api/opportunity";

    const EXCHANGES = [
      { id: 1, name: "hyperliquid", logoURL: "https://yieldgapweb-production.up.railway.app/assets/logos/hl_logo.svg", makerFee: 0.00015, takerFee: 0.0004 },
      { id: 4, name: "aster", logoURL: "https://yieldgapweb-production.up.railway.app/assets/logos/as_logo.svg", makerFee: 0.0001, takerFee: 0.00035 },
      { id: 6, name: "lighter", logoURL: "https://yieldgapweb-production.up.railway.app/assets/logos/lt_logo.svg", makerFee: 0, takerFee: 0 },
      { id: 7, name: "pacifica", logoURL: "https://yieldgapweb-production.up.railway.app/assets/logos/pf_logo.svg", makerFee: 0.00015, takerFee: 0.0004 }
    ];

    function formatNumber(n) {
      if (n == null) return "-";
      if (Math.abs(n) >= 1e9) return (n/1e9).toFixed(2)+"B";
      if (Math.abs(n) >= 1e6) return (n/1e6).toFixed(2)+"M";
      if (Math.abs(n) >= 1e3) return (n/1e3).toFixed(2)+"K";
      return Number(n).toLocaleString();
    }

    function YieldGapArbUI() {
      const [opps, setOpps] = React.useState([]);
      const [lastUpdated, setLastUpdated] = React.useState(null);
      const [searchToken, setSearchToken] = React.useState("");
      const [filterExchange, setFilterExchange] = React.useState("");
      const [sortConfig, setSortConfig] = React.useState({ key: "apr", direction: "desc" });
      const [page, setPage] = React.useState(1);
      const pageSize = 20;

      const exchMap = React.useMemo(() => {
        const m = {};
        EXCHANGES.forEach(e => m[e.id] = e);
        return m;
      }, []);

      const [selectedExchanges, setSelectedExchanges] = React.useState(EXCHANGES.map(ex => ex.id));

      const fetchOpp = async () => {
        try {
          const query = selectedExchanges.length ? `?exchanges=${selectedExchanges.join(",")}` : "";

          // üîê Enviar header de autenticaci√≥n
          const resp = await fetch(BASE_URL + query, {
            headers: {
              "Authorization": `Bearer ${window.API_TOKEN || ""}`
            }
          });

          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const json = await resp.json();

          setOpps(Array.isArray(json.opportunities) ? json.opportunities : []);
          setLastUpdated(json.lastUpdate ? new Date(json.lastUpdate).toLocaleTimeString() : "-");
        } catch (err) {
          console.error("Error fetching opportunities:", err);
        }
      };

      React.useEffect(() => { fetchOpp(); }, [selectedExchanges]);
      React.useEffect(() => { const i = setInterval(fetchOpp, 10000); return () => clearInterval(i); }, [selectedExchanges]);

      const sortedFilteredOpps = React.useMemo(() => {
        let data = [...opps];

        if (searchToken) {
          data = data.filter(o => o.token.toLowerCase().includes(searchToken.toLowerCase()));
          setPage(1);
        }

        if (filterExchange) {
          data = data.filter(o =>
            exchMap[o.buyExchange]?.name === filterExchange ||
            exchMap[o.sellExchange]?.name === filterExchange
          );
          setPage(1);
        }

        if (sortConfig.key) {
          data.sort((a, b) => {
            let valA, valB;
            if (sortConfig.key === "apr") {
              const normalize = (v) => {
                if (v === -1) return -Infinity; // lo tratamos como el m√°s bajo posible
                return v;
              };
              valA = normalize(a.apr);
              valB = normalize(b.apr);
            } else if (sortConfig.key === "spread") {
              valA = a.buyAsk && a.sellBid ? ((a.sellBid - a.buyAsk) / a.buyAsk) * 100 : 0;
              valB = b.buyAsk && b.sellBid ? ((b.sellBid - b.buyAsk) / b.buyAsk) * 100 : 0;
            } else {
              valA = a[sortConfig.key];
              valB = b[sortConfig.key];
            }
            if (valA < valB) return sortConfig.direction === "asc" ? -1 : 1;
            if (valA > valB) return sortConfig.direction === "asc" ? 1 : -1;
            return 0;
          });
        }

        return data;
      }, [opps, searchToken, filterExchange, sortConfig]);

      const paginatedOpps = sortedFilteredOpps.slice((page-1)*pageSize, page*pageSize);
      const totalPages = Math.max(1, Math.ceil(sortedFilteredOpps.length / pageSize));

      const handleSort = (key) => {
        setSortConfig(prev => {
          if (prev.key === key) {
            return { key, direction: prev.direction === "asc" ? "desc" : "asc" };
          }
          return { key, direction: "asc" };
        });
      };

      return (
        <div className="container-fluid bg-dark text-light min-vh-100 py-5">
          <div className="text-center mb-4">
            <span style={{fontSize:"1rem",color:"#fff"}}>
              Support me to be blessed üôèüèº:&nbsp;
              <b>0x1e0d5bf32370A4B207e5a3EeA5cABb96C5C87d3b</b>
            </span>
          </div>
          <div className="d-flex header-row mb-3 justify-content-between">
            <div className="header-left">
              <div className="logo-circle me-2">
                <img src="SKULLKID.png" alt="Logo" />
              </div>
              <div>
                <h1 className="h1 mb-0">
                  SkullBitrage <span style={{fontSize:"0.8rem",color:"#ccc"}}>by <a href="https://twitter.com/momiamfree" target="_blank" rel="noopener noreferrer" style={{color:"#ccc",textDecoration:"none"}}>@momiamfree</a></span>
                </h1>
              </div>
            </div>
            <div className="header-right">
              {/* filters on the right as requested */}
              <div className="d-flex controls-row align-items-center">
                <input
                  type="text"
                  className="form-control bg-dark text-light me-2"
                  placeholder="Search token..."
                  value={searchToken}
                  onChange={e => setSearchToken(e.target.value)}
                  style={{minWidth: "180px"}}
                />
                  <div className="dropdown">
                    <button className="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                      Exchanges
                    </button>
                    <ul className="dropdown-menu dropdown-menu-end bg-dark text-light p-2">
                      {EXCHANGES.map(ex => (
                        <li key={ex.id}>
                          <div className="form-check">
                            <input
                              type="checkbox"
                              className="form-check-input"
                              id={ex.name}
                              checked={selectedExchanges.includes(ex.id)}
                              onChange={e => {
                                if (e.target.checked) {
                                  setSelectedExchanges(prev => [...prev, ex.id]);
                                } else {
                                  setSelectedExchanges(prev => prev.filter(v => v !== ex.id));
                                }
                              }}
                            />
                            <label className="form-check-label" htmlFor={ex.name}><img src={ex.logoURL} alt={ex.name} style={{width:"18px",height:"18px",objectFit:"contain"}} className="me-2"/>{ex.name}</label>
                          </div>
                        </li>
                      ))}
                    </ul>
                  </div>

              </div>
            </div>
          </div>
          {/* üîπ Exchanges row con referral & descuento */}
          <div className="d-flex flex-wrap justify-content-center gap-3 my-3 mt-5">
            {/* Hyperliquid */}
            <a href="https://app.hyperliquid.xyz/join/SKULLBITRAGE"
              target="_blank" rel="noopener noreferrer nofollow sponsored"
              className="d-flex align-items-center gap-1 px-2 py-1 border border-secondary rounded-pill text-light text-decoration-none hover-effect small">
              <img src="https://yieldgapweb-production.up.railway.app/assets/logos/hl_logo.svg"
                  alt="Hyperliquid" style={{width:"16px",height:"16px",objectFit:"contain"}}/>
              <span className="ms-1 fw-semibold">4% off fees</span>
            </a>

            {/* Aster */}
            <a href="https://www.asterdex.com/en/referral/F1d31d"
              target="_blank" rel="noopener noreferrer nofollow sponsored"
              className="d-flex align-items-center gap-1 px-2 py-1 border border-secondary rounded-pill text-light text-decoration-none hover-effect small">
              <img src="https://yieldgapweb-production.up.railway.app/assets/logos/as_logo.svg"
                  alt="Aster" style={{width:"16px",height:"16px",objectFit:"contain"}}/>
              <span className="ms-1 fw-semibold">6% off fees</span>
            </a>

            {/* Pacifica */}
            <a href="https://app.pacifica.fi?referral=skullkid"
              target="_blank" rel="noopener noreferrer nofollow sponsored"
              className="d-flex align-items-center gap-1 px-2 py-1 border border-secondary rounded-pill text-light text-decoration-none hover-effect small">
              <img src="https://yieldgapweb-production.up.railway.app/assets/logos/pf_logo.svg"
                  alt="Aster" style={{width:"16px",height:"16px",objectFit:"contain"}}/>
              <span className="ms-1 fw-semibold">5% point boost</span>
            </a>


          </div>
          {/* Table */}
          <div className="table-responsive">
            <table className="table table-dark table-striped mb-0 text-sm text-center align-middle w-100">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Token</th>
                  <th onClick={() => handleSort("apr")} style={{cursor:"pointer"}}>
                    {sortConfig.key==="apr" && (
                      sortConfig.direction==="asc" 
                        ? <i className="bi bi-arrow-up-short me-1"></i> 
                        : <i className="bi bi-arrow-down-short me-1"></i>
                    )}
                    APR % &nbsp;
                    <i className="bi bi-info-circle" 
                      data-bs-toggle="tooltip" 
                      data-bs-html="true"
                      title="APR is calculated from the funding rate difference between exchanges. 
              Example: (FundingSell - FundingBuy) √ó 8760 (hours/year). 
              This approximates the yearly return of a delta-neutral position."></i>
                  </th>
                  <th>Long / Short</th>
                  <th onClick={() => handleSort("spread")} style={{cursor:"pointer"}}>
                    {sortConfig.key==="spread" && (
                      sortConfig.direction==="asc" 
                        ? <i className="bi bi-arrow-up-short me-1"></i> 
                        : <i className="bi bi-arrow-down-short me-1"></i>
                    )}
                    Price Spread &nbsp; 
                    <i className="bi bi-info-circle" 
                      data-bs-toggle="tooltip" 
                      data-bs-html="true"
                      title="The price spread is calculated using the taker prices: the ASK from the exchange where you buy and the BID from the exchange where you sell. 
              This shows the real executable market spread."></i>
                  </th>
                  <th>Open Interest</th>
                  <th>24h Volume</th>
                </tr>
              </thead>

              <tbody>
                {paginatedOpps.map((opp, i) => {
                  const buyEx = exchMap[opp.buyExchange];
                  const sellEx = exchMap[opp.sellExchange];
                  const apr = opp.apr;
                  const priceSpreadPct = opp.spread * 100;
                  return (
                    <tr key={i}>
                      <td>#{(page-1)*pageSize + i + 1}</td>
                      <td className="fw-semibold">{opp.token}</td>
                      <td className={
                        opp.apr > 1 ? "text-success fw-bold" :
                        opp.apr === -0 ? "text-danger fw-bold" : 
                        opp.apr < 1 ? "text-danger fw-bold" : "text-danger fw-bold"
                      }>
                        {Math.round(opp.apr) + " %"}
                      </td>
                      <td>
                        <div className="d-flex align-items-center justify-content-center gap-2">
                          {buyEx?.logoURL && <img src={buyEx.logoURL} alt={buyEx.name} style={{width:"20px",height:"20px"}} />}
                          <span>/</span>
                          {sellEx?.logoURL && <img src={sellEx.logoURL} alt={sellEx.name} style={{width:"20px",height:"20px"}} />}
                        </div>
                      </td>
                      <td className={priceSpreadPct>0 ? "text-success fw-bold" : priceSpreadPct<0 ? "text-danger fw-bold" : "text-danger fw-bold"}>
                        {priceSpreadPct!==null ? priceSpreadPct.toFixed(2) : "-"} %
                      </td>
                      <td>{formatNumber(opp.buyOI)} / {formatNumber(opp.sellOI)}</td>
                      <td>{formatNumber(opp.buyVolume)} / {formatNumber(opp.sellVolume)}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Pagination */}
          <div className="d-flex justify-content-between align-items-center mt-3">
            <button
              className="btn btn-outline-light btn-sm"
              disabled={page === 1}
              onClick={() => setPage(p => Math.max(1, p-1))}
            >
              <i className="bi bi-arrow-left"></i> Previous
            </button>
            <span>Page {page} of {Math.max(1, Math.ceil(sortedFilteredOpps.length / pageSize))}</span>
            <button
              className="btn btn-outline-light btn-sm"
              disabled={page >= Math.ceil(sortedFilteredOpps.length / pageSize)}
              onClick={() => setPage(p => Math.min(Math.ceil(sortedFilteredOpps.length / pageSize), p+1))}
            >
              Next <i className="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<YieldGapArbUI />);

    // After React renders, enable Bootstrap tooltips & copy button behavior
    document.addEventListener("DOMContentLoaded", function() {
      // enable tooltips
      const tooltipElList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipElList.forEach(function (tooltipEl) {
        new bootstrap.Tooltip(tooltipEl);
      });

      // copy wallet button
      const copyBtn = document.getElementById("copyWalletBtn");
      if (copyBtn) {
        copyBtn.addEventListener("click", () => {
          const inp = document.getElementById("walletAddress");
          if (!inp) return;
          inp.select();
          inp.setSelectionRange(0, 99999);
          navigator.clipboard?.writeText(inp.value).then(() => {
            copyBtn.innerText = "Copied";
            setTimeout(()=> copyBtn.innerText = "Copy", 1200);
          }).catch(()=> alert("Copy failed"));
        });
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
